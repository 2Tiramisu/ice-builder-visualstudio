<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) 2009-2015 ZeroC, Inc. All rights reserved. -->
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Import IceBuilder schema -->
  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
    <AvailableItemName Include="IceBuilder"/>
  </ItemGroup>

  <Target Name="IceBuilder_Validate">
    <Error Text="Ice Installation not detected. You may need to update Ice Home in 'Tools > Options > Ice Builder'"
           Condition="'$(IceHome)' == ''" />

    <Error Text="The selected C++ Runtime Library is not supported by Ice; Ice requires /MD or /MDd."
           Condition="'%(ClCompile.RuntimeLibrary)' != 'MultiThreadedDebugDLL' And
                      '%(ClCompile.RuntimeLibrary)' != 'MultiThreadedDLL' "/>
  </Target>
  
  <Target Name="IceBuilder_Depend"
          Inputs="@(IceBuilder)"
          DependsOnTargets="IceBuilder_Validate"
          Outputs="%(IceBuilder.OutputDir)\IceBuilder.Depend.xml">
    <Message Text="Updating Slice File Dependencies"/>
    <MakeDir Directories="%(IceBuilder.OutputDir)" Condition="!Exists('%(IceBuilder.OutputDir)')"/>
    <Slice2CppDependTask IceHome="$(IceHome)"
                     OutputDir="%(IceBuilder.OutputDir)"
                     WorkingDirectory="$(MSBuildProjectDirectory)"
                     DependFile="%(IceBuilder.OutputDir)\IceBuilder.Depend.xml"
                     IncludeDirectories="%(IceBuilder.IncludeDirectories)"
                     AdditionalOptions="%(IceBuider.AdditionalOptions)"
                     Sources="@(IceBuilder)">
      <Output ItemName="_IceBuilder" TaskParameter="Outputs"/>
    </Slice2CppDependTask>
  </Target>

  <Target Name="IceBuilder_Generated">

    <!-- Include generated items to the build if IncludeGeneratedItems is set -->
    <Slice2CppGeneratedTask OutputDir="%(IceBuilder.OutputDir)" Sources="@(IceBuilder)"
                            Condition="'$(IncludeGeneratedItems)' == 'Yes'">
      <Output ItemName="CLCompile" TaskParameter="GeneratedSources"/>
      <Output ItemName="CLInclude" TaskParameter="GeneratedHeaders"/>
    </Slice2CppGeneratedTask>
    
    <!-- Preprend our settings to C++ configuration settings -->
    <PropertyGroup>
      <_IceBuilder_OutputDir>%(IceBuilder.OutputDir)</_IceBuilder_OutputDir>
    </PropertyGroup>
    <ItemGroup>
      <ClCompile>
        <AdditionalIncludeDirectories>$(_IceBuilder_OutputDir);%(ClCompile.AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
      </ClCompile>
    </ItemGroup>
  </Target>

  <Target Name="IceBuilder_Compile"
          DependsOnTargets="IceBuilder_Depend;IceBuilder_Generated;IceBuilder_Validate"
          Inputs="%(_IceBuilder.FullPath);%(_IceBuilder.Depends)"
          Outputs="%(_IceBuilder.OutputDir)\%(_IceBuilder.RelativeDir)%(_IceBuilder.FileName).%(_IceBuilder.SourceExt)"
          BeforeTargets="CLCompile">
    <MakeDir Directories="%(_IceBuilder.OutputDir)" Condition="!Exists('%(_IceBuilder.OutputDir)')"/>

    <Message Text="Compiling %(_IceBuilder.Identity)"/>
    <Slice2CppTask IceHome="$(IceHome)"
                   OutputDir="%(_IceBuilder.OutputDir)"
                   WorkingDirectory="$(MSBuildProjectDirectory)"
                   Ice="%(_IceBuilder.Ice)"
                   Underscore="%(_IceBuilder.Underscore)"
                   Stream="%(_IceBuilder.Stream)"
                   Checksum="%(_IceBuilder.Checksum)"
                   IncludeDirectories="%(_IceBuilder.IncludeDirectories)"
                   AdditionalOptions="%(_IceBuider.AdditionalOptions)"
                   DLLExport="%(_IceBuilder.DLLExport)"
                   IncludeDir="%(_IceBuilder.IncludeDir)"
                   HeaderExt="%(_IceBuilder.HeaderExt)"
                   SourceExt="%(_IceBuilder.SourceExt)"
                   Sources="%(_IceBuilder.Identity)"/>
  </Target>

  <Target Name="IceBuilder_Clean" BeforeTargets="Clean">
    <PropertyGroup>
      <_IceBuilderGeneratedSourceFile>$([System.IO.Path]::Combine(%(IceBuilder.OutputDir), 
                                              %(IceBuilder.RelativeDir), 
                                              %(IceBuilder.FileName).%(IceBuilder.SourceExt)))
      </_IceBuilderGeneratedSourceFile>
      <_IceBuilderGeneratedHeaderFile>$([System.IO.Path]::Combine(%(IceBuilder.OutputDir), 
                                              %(IceBuilder.RelativeDir), 
                                              %(IceBuilder.FileName).%(IceBuilder.HeaderExt)))
      </_IceBuilderGeneratedHeaderFile>
    </PropertyGroup>
    <Delete Files="$(_IceBuilderGeneratedSourceFile);$(_IceBuilderGeneratedHeaderFile)"/>
    <Delete Files="%(IceBuilder.OutputDir)\IceBuilder.Depend.xml"/>
  </Target>

  
  <PropertyGroup Condition="'$([MSBuild]::GetRegistryValue(`HKEY_CURRENT_USER\Software\ZeroC\IceBuilder\$(ProjectGuid)`, `IceBuilder_Default`))' != ''">
    <BuildDependsOn>
      $([MSBuild]::GetRegistryValue(`HKEY_CURRENT_USER\Software\ZeroC\IceBuilder\$(ProjectGuid)`, `IceBuilder_Default`))
    </BuildDependsOn>
  </PropertyGroup>
</Project>
